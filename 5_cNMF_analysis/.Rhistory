pull(program)
singleton_programs = c(singleton_programs, singletons)
}
write.table(singleton_programs, paste0("singletons.txt"), append = F, quote = F, row.names = F, col.names = F)
suppressMessages(suppressWarnings({
library(RColorBrewer)
library(fgsea)
library(dplyr)
library(Seurat)
library(dplyr)
library(ComplexHeatmap)
library(circlize)
library(tidyverse)
}))
base_dir = "/Users/kr72/Documents/projects/aging_blood/prepare_for_publication/"
setwd(paste0(base_dir, "5_cNMF_analysis"))
if (!dir.exists("meta_clusters_starcat")) dir.create("meta_clusters_starcat")
#### Read input files ####
# Read cNMF programs and filter out singletons
cNMF_results = read.table("cnmf_output/Z_scores.total_cNMF_output.csv", row.names = 1, header = T, sep=",")
cNMF_results$Sample = NULL
genes = colnames(cNMF_results)
singletons = read.table("singletons.txt",header = F)$V1
cNMF_results = cNMF_results[! rownames(cNMF_results) %in% singletons, ]
# Read TPM files to produce averaged TPM meta-programs for *CAT
cGEP_TPMs = read.table("cnmf_output/TPMs.total_cNMF_output.csv", row.names = 1, header = T, sep=",")
cGEP_TPMs = cGEP_TPMs[! rownames(cGEP_TPMs) %in% singletons, ]
# Read cluster assignment
clusters = read.table("meta_clusters_starcat/clusters.csv", sep=",", header = T)
#### Subset representative clusters and compute averaged Z-scores and TPM vectors for them ####
# Compute Pearson correlation for visualization
full_similarity_matrix = cor(scale(t(data.matrix(cNMF_results))))
# Select clusters that have at least four programs coming from at least two datasets
selected_clusters = clusters %>%
filter(Cluster != "Unclustered") %>%
rowwise() %>%
mutate(Dataset = strsplit(Member, "_")[[1]][2]) %>%
group_by(Cluster) %>%
filter(n_distinct(Dataset)>1 & n()>3) %>%
dplyr::select(-Dataset) %>%
mutate(Cluster = paste0("metaGEP:", Cluster))
# Make averaged Z-score vectors for GSEA analysis
averaged_metaGEP = cNMF_results %>%
rownames_to_column("Member") %>%
left_join(selected_clusters) %>%
filter(! is.na(Cluster)) %>%
group_by(Cluster) %>%
summarise(across(2:(ncol(cNMF_results)+1), \(x) mean(x, na.rm = TRUE)), .groups = "drop") %>%
column_to_rownames("Cluster")
write.table(averaged_metaGEP, "meta_clusters_starcat/metaGEP.Z_scores.tsv", quote = F, append = F, row.names = T, col.names = T, sep = "\t")
# Make averaged TPM vectors for *CAT
averaged_metaGEP_TPMs = cGEP_TPMs %>%
dplyr::select(-Sample) %>%
rownames_to_column("Member") %>%
left_join(selected_clusters) %>%
filter(! is.na(Cluster)) %>%
group_by(Cluster) %>%
summarise(across(2:(ncol(cNMF_results)+1), \(x) mean(x, na.rm = TRUE)), .groups = "drop") %>%
column_to_rownames("Cluster")
write.table(averaged_metaGEP_TPMs, "meta_clusters_starcat/metaGEP.Z_score_based_TPMs.tsv", quote = F, append = F, row.names = T, col.names = T, sep = "\t")
# Subset correlation matrix for selected clusters
cluster_members = selected_clusters$Member
similarity_matrix = full_similarity_matrix[cluster_members, cluster_members]
#### Plot Fig.2b ####
# Define cluster colors
cluster_names = selected_clusters$Cluster
unique_clusters = unique(cluster_names)
color_palette = c(hcl.colors(length(unique_clusters), "Roma"))
color_mapping = setNames(color_palette, unique_clusters)
cluster_colors = color_mapping[cluster_names]
# Define dataset colors
datasets = stringr::str_extract(rownames(similarity_matrix), "_([A-Za-z0-9]+)_", group = 1)
unique_datasets = unique(datasets)
color_palette = brewer.pal(8, "Paired")[c(1,2,8,6)]
color_palette[3] = "#ffcb00"
color_mapping = setNames(color_palette, unique_datasets)
dataset_colors = color_mapping[datasets]
# Minor graphic tweaks
ht_opt$COLUMN_ANNO_PADDING = unit(0.5, "mm")
ht_opt$ANNOTATION_LEGEND_PADDING = unit(0.5, "mm")
ht_opt$HEATMAP_LEGEND_PADDING  = unit(0.5, "mm")
# Define annotation block
anno = columnAnnotation(
Cluster = cluster_names,
Dataset = datasets,
col = list(
Cluster = cluster_colors,
Dataset = dataset_colors),
show_legend = T,
annotation_name_gp = gpar(fontsize = 6),
annotation_legend_param = list(
Cluster = list(direction="vertical"),
Dataset = list(direction="vertical"),
grid_height = unit(1, "mm"),
grid_width = unit(1, "mm"),
row_gap = unit(0.1, "mm"),
title_gp = gpar(fontsize = 6, fontface = "bold"),
labels_gp = gpar(fontsize = 5)
),
simple_anno_size = unit(1.5, "mm")
)
# Define colorscale for the heatmap
col_fun = colorRamp2(c(-1,-0.75,-0.5,-0.25,0,0.25,0.5,0.75,1), colors = c(hcl.colors(6, "Teal")[2:5], "white", rev(hcl.colors(6, "Oranges")[2:5])))
# Plot heatmap
hm = Heatmap(similarity_matrix,
width = unit(1, "snpc"), height = unit(1, "snpc"),
col = col_fun,
row_order = selected_clusters$Member,
column_order = selected_clusters$Member,
show_column_names = F,
show_row_names = F,
show_heatmap_legend = T,
bottom_annotation = anno,
row_names_gp = gpar(fontsize = 5),
column_names_gp = gpar(fontsize = 5),
show_parent_dend_line = T,
heatmap_legend_param = list(
direction = "vertical",
labels_gp = gpar(fill = dataset_colors, fontsize = 5),
title_gp = gpar(fontsize = 6, fontface = "bold"),
title = "Correlation",
legend_height = unit(7, "mm"),
grid_width = unit(1, "mm")),
row_gap = unit(0, "mm"),
column_gap = unit(0, "mm"))
hm
# Save as pdf
pdf("meta_clusters_starcat/Fig.2b.pdf", width = 3.3, height = 2.5)
draw(hm, annotation_legend_side = "right", merge_legend = TRUE, heatmap_legend_side = "right")
dev.off()
#### Plot all programs with their GSEA annotation for supplements ####
# Reorder correlation matrix entries
full_similarity_matrix = full_similarity_matrix[clusters$Member, clusters$Member]
# Read and reformat GSEA results
gsea_res = data.table::fread(paste0("gsea_results/total_cNMF_fgseaRes.txt"), sep="\t", sep2=c("", " ", ""))
gsea_wide = gsea_res %>%
dplyr::select(pathway, padj, NES, Program) %>%
filter(pathway %in% c("Aging_signature", "MEP_signature", "GMP_signature", "CLP_signature")) %>%
mutate(NES = - sign(NES) * log(padj)) %>%
dplyr::select(-padj) %>%
pivot_wider(values_from = NES, names_from = pathway)
gsea_anno = gsea_wide[match(rownames(full_similarity_matrix), gsea_wide$Program), ]
# GSEA colorbar
col_fun_gsea = colorRamp2(c(min(min(gsea_res$NES, na.rm = T), log(0.05)-1), 0, max(max(gsea_res$NES, na.rm = T), -log(0.05)+1)), c("steelblue3", "white","firebrick3"))
# Define GSEA annotation block
row_anno = rowAnnotation(
GMP_sig = gsea_anno$GMP_signature,
MEP_sig = gsea_anno$MEP_signature,
MLP_sig = gsea_anno$CLP_signature,
Aging_sig = gsea_anno$Aging_signature,
col = list(
GMP_sig = col_fun_gsea,
MEP_sig = col_fun_gsea,
MLP_sig = col_fun_gsea,
Aging_sig = col_fun_gsea),
show_legend = T,
annotation_name_gp = gpar(fontsize = 6),
annotation_legend_param = list(
GMP_sig = list(direction = "vertical"),
MEP_sig = list(direction = "vertical"),
MLP_sig = list(direction = "vertical"),
Aging_sig = list(direction = "vertical"),
grid_height = unit(1, "mm"),
grid_width = unit(1, "mm"),
row_gap = unit(0.1, "mm"),
title_gp = gpar(fontsize = 6, fontface = "bold"),
labels_gp = gpar(fontsize = 5)
),
simple_anno_size = unit(1.5, "mm")
)
# Define cluster colors
cluster_names = clusters$Cluster
unique_clusters = unique(cluster_names)
color_palette = c(hcl.colors(length(unique_clusters) - 1, "Roma"), "grey")
color_mapping = setNames(color_palette, unique_clusters)
cluster_colors = color_mapping[cluster_names]
# Define dataset colors
datasets = stringr::str_extract(rownames(full_similarity_matrix), "_([A-Za-z0-9]+)_", group = 1)
unique_datasets = unique(datasets)
color_palette = brewer.pal(8, "Paired")[c(1,2,8,6)]
color_palette[3] = "#ffcb00"
color_mapping = setNames(color_palette, unique_datasets)
dataset_colors = color_mapping[datasets]
# Define top annotation block
column_anno = columnAnnotation(
Cluster = cluster_names,
Dataset = datasets,
col = list(
Cluster = cluster_colors,
Dataset = dataset_colors),
show_legend = T,
annotation_name_gp = gpar(fontsize = 6),
annotation_legend_param = list(
Cluster = list(direction="vertical"),
Dataset = list(direction="vertical"),
grid_height = unit(1, "mm"),
grid_width = unit(1, "mm"),
row_gap = unit(0.1, "mm"),
title_gp = gpar(fontsize = 6, fontface = "bold"),
labels_gp = gpar(fontsize = 5)
),
simple_anno_size = unit(1.5, "mm")
)
# Plot heatmap
hm = Heatmap(full_similarity_matrix,
width = unit(1, "snpc"), height = unit(1, "snpc"),
col = col_fun,
row_order = clusters$Member,
column_order = clusters$Member,
show_column_names = F,
show_row_names = F,
show_heatmap_legend = T,
top_annotation = column_anno,
right_annotation = row_anno,
row_names_gp = gpar(fontsize = 5),
column_names_gp = gpar(fontsize = 5),
show_parent_dend_line = T,
heatmap_legend_param = list(
direction = "vertical",
labels_gp = gpar(fill = dataset_colors, fontsize = 5),
title_gp = gpar(fontsize = 6, fontface = "bold"),
title = "Correlation",
legend_height = unit(7, "mm"),
grid_width = unit(1, "mm")),
row_gap = unit(0, "mm"),
column_gap = unit(0, "mm"))
hm
# Save as pdf
pdf("meta_clusters_starcat/Suppl.Fig.2b.pdf", width = 7.5, height = 6)
draw(hm, annotation_legend_side = "right", merge_legend = TRUE, heatmap_legend_side = "right")
dev.off()
suppressMessages(suppressWarnings({
library(RColorBrewer)
library(fgsea)
library(dplyr)
library(Seurat)
library(dplyr)
library(ComplexHeatmap)
library(circlize)
library(tidyverse)
}))
base_dir = "/Users/kr72/Documents/projects/aging_blood/prepare_for_publication/"
setwd(paste0(base_dir, "5_cNMF_analysis"))
##### Create a list of pathways #####
# Aging signature
de_results = read.table(paste0(base_dir, "2_differential_expression_analysis/DESeq2_results.Aged_vs_Young.csv"), sep=",", header = T)
aging_sig = de_results %>%
filter(padj<0.05, log2FoldChange>1) %>%
pull(gene)
# Human dormancy signature from https://doi.org/10.1016/j.stem.2021.07.003
garcia_table = readxl::read_xlsx(paste0(base_dir, "input_data/signatures/mmc2.xlsx"), sheet = 1)
garcia_signature = garcia_table %>%
filter(genename!="None") %>%
filter(logFC < -2,FDR<0.00001) %>%
pull(genename) %>%
unique()
graham_signature = read.table(paste0(base_dir, "input_data/signatures/graham_quiescence_up.txt"), header = F)$V1
mep_sig = read.table(paste0(base_dir, "input_data/signatures/mep_sig.tsv"))$x
gmp_sig = read.table(paste0(base_dir, "input_data/signatures/gmp_sig.tsv"))$x
clp_sig = read.table(paste0(base_dir, "input_data/signatures/clp_sig.tsv"))$x
ap1_complex = c("FOS", "FOSB", "JUN", "JUNB", "JUND", "FOSL1", "FOSL2", "ATF2", "ATF3", "ATF4", "ATF6", "ATF7", "BATF", "BATF2", "BATF3", "MAFA", "MAFB", "MAF", "MAFG", "MAFF", "MAFK")
hallmark_pathways = gmtPathways(paste0(base_dir, "input_data/signatures/h.all.v2024.1.Hs.symbols.gmt.txt"))
c2_cp_pathways = gmtPathways(paste0(base_dir, "input_data/signatures/c2.cp.v2024.1.Hs.symbols.gmt.txt"))
main_pathways = list(graham_signature, garcia_signature, aging_sig, mep_sig, gmp_sig, clp_sig, ap1_complex)
names(main_pathways) = c("Graham_quiescence", "Garcia_quiescence", "Aging_signature", "MEP_signature", "GMP_signature", "CLP_signature", "AP-1_complex")
pathways = c(main_pathways, hallmark_pathways, c2_cp_pathways)
#### Run GSEA and visualise enrichment scores for metaGEPs ####
# Read metaGEPs
programs = read.table("meta_clusters_starcat/metaGEP.Z_scores.tsv", row.names = 1, header = T, sep="\t")
fgseaRes_total = data.frame()
# Run GSEA for each metaGEP
for (i in 1:nrow(programs)) {
entry = programs[i,]
ranks = as.numeric(entry)
names(ranks) = colnames(entry)
# GSEA
fgseaRes = fgsea(pathways = pathways,
stats    = ranks,
minSize  = 5,
eps      = 0.0,
maxSize  = 500,
nPermSimple = 10000)
fgseaRes$Program = rownames(entry)
fgseaRes_total = rbind(fgseaRes_total, fgseaRes)
}
# Save results
data.table::fwrite(fgseaRes_total, file=paste0("gsea_results/metaGEP_fgseaRes.txt"), sep="\t", sep2=c("", " ", ""), append = F)
# Select relevant pathways to visualize
relevant_pathways = c("Aging_signature", "Graham_quiescence", "Garcia_quiescence", "MEP_signature", "GMP_signature", "CLP_signature", "AP-1_complex", "HALLMARK_TNFA_SIGNALING_VIA_NFKB", "REACTOME_CELL_CYCLE", "HALLMARK_E2F_TARGETS", "HALLMARK_APOPTOSIS", "WP_IL18_SIGNALING", "WP_NUCLEAR_RECEPTORS_METAPATHWAY", "PID_AP1_PATHWAY", "HALLMARK_HYPOXIA", "HALLMARK_G2M_CHECKPOINT", "HALLMARK_INFLAMMATORY_RESPONSE")
# Create an intermediate df with both NESs and significance signs, for all combinations of programs and gene sets
temp = fgseaRes_total %>%
filter(pathway %in% relevant_pathways) %>%
arrange(pathway = factor(pathway, levels = relevant_pathways)) %>%
dplyr::select(ID=pathway, padj, NES, Program) %>%
mutate(sign = case_when(padj < 0.001 ~ "***",
padj < 0.01 ~ "**",
padj < 0.05 ~ "*",
.default = ""))
# Extract NES and significance levels into separate objects
NES_df = temp %>%
pivot_wider(names_from = Program, values_from = NES, id_cols = ID)
p_val_df = temp %>%
pivot_wider(names_from = Program, values_from = sign, id_cols = ID)
# Move gene names to rownames
ids = NES_df[,1]$ID
NES_df = as.matrix(NES_df[,-1])
rownames(NES_df) = ids
NES_df = t(NES_df)
ids = p_val_df[,1]$ID
p_val_df = as.matrix(p_val_df[,-1])
rownames(p_val_df) = ids
p_val_df = t(p_val_df)
# Make sure both cell types and gene sets in the same order in two dfs
all(rownames(NES_df) == rownames(p_val_df))
all(colnames(NES_df) == colnames(p_val_df))
# Generate color span for NES
col_fun = colorRamp2(c(min(NES_df, na.rm = T), 0, max(NES_df, na.rm = T)), c("steelblue3", "white", "firebrick3"))
# Define cluster colors
cluster_names = rownames(NES_df)
color_palette = hcl.colors(length(cluster_names), "Roma")
color_mapping = setNames(color_palette, cluster_names)
cluster_colors = color_mapping[cluster_names]
# Generate annotation
row_anno = rowAnnotation(
Cluster = cluster_names,
col = list(
Cluster = cluster_colors),
show_legend = T,
annotation_name_gp = gpar(fontsize = 6),
annotation_legend_param = list(
Cluster = list(nrow = 1),
grid_height = unit(1, "mm"),
grid_width = unit(1, "mm"),
row_gap = unit(0.1, "mm"),
title_gp = gpar(fontsize = 6, fontface = "bold"),
labels_gp = gpar(fontsize = 5)),
simple_anno_size = unit(1.5, "mm")
)
# Generate heatmap
hm = Heatmap(NES_df,
right_annotation = row_anno,
cluster_rows = F,
cluster_columns = T,
show_column_dend = F,
show_row_names = T,
name = "NES",
row_title_gp = gpar(fontsize = 5),
row_names_side = "right",
row_names_gp = gpar(fontsize = 5),
column_names_gp = gpar(fontsize = 5),
heatmap_legend_param = list(direction = "vertical",
labels_gp = gpar(fontsize = 5),
title_gp = gpar(fontsize = 6, fontface = "bold"),
title = "NES",
legend_height = unit(7, "mm"),
grid_width = unit(1, "mm")),
border = T,
border_gp = gpar(lwd = 0.5),
col = col_fun,
cell_fun = function(j, i, x, y, width, height, fill) {
grid.text(sprintf("%s", p_val_df[i, j]), x, y, gp = gpar(fontsize = 5))
}
)
hm
# Save as pdf
pdf("meta_clusters_starcat/Fig.2c.pdf", width = 2.5, height = 2.5)
draw(hm, merge_legend = TRUE, heatmap_legend_side = "right", padding = unit(c(0, 0, 0, 0), "mm"))
dev.off()
base_dir = "/Users/kr72/Documents/projects/aging_blood/prepare_for_publication_six_datasets_in_the_middle/"
setwd(paste0(base_dir, "1_dataset_preparation"))
# Read HSPCs object and combine HSCs and MPPs
seu = readRDS("seu_full_object_hscs_marked.rds")
# Read HSPCs object and combine HSCs and MPPs
seu = readRDS("/Users/kr72/Documents/projects/aging_blood/prepare_for_publication_six_datasets_in_the_middle/1_dataset_preparation/seu_bmm_annotated_merged.rds")
seu
seu = NormalizeData(seu)
seu$predicted_CellType[seu$predicted_CellType %in% c("HSC", "MPP-MkEry", "MPP-MyLy")] = "HSC_MPP"
# Contrast HSC+MPP to committed populations
Idents(seu) = "predicted_CellType"
mep_markers = FindMarkers(seu, ident.1 = "MEP", ident.2 = "HSC_MPP")
gmp_markers = FindMarkers(seu, ident.1 = "Early GMP", ident.2 = "HSC_MPP")
suppressMessages(suppressWarnings({
library(Seurat)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(fgsea)
library(RColorBrewer)
library(rstatix)
library(cowplot)
}))
base_dir = "/Users/kr72/Documents/projects/aging_blood/prepare_for_publication/"
setwd(paste0(base_dir, "5_cNMF_analysis"))
#### Read the master seurat object ####
seu_total = readRDS(paste0(base_dir, "1_dataset_preparation/seu_hsc.total.rds"))
# Aging signature
de_results = read.table(paste0(base_dir, "2_differential_expression_analysis/DESeq2_results.Aged_vs_Young.csv"), sep=",", header = T)
aging_sig = de_results %>%
filter(padj<0.05, log2FoldChange>1) %>%
pull(gene)
# Human dormancy signature from https://doi.org/10.1016/j.stem.2021.07.003
garcia_table = readxl::read_xlsx(paste0(base_dir, "input_data/signatures/mmc2.xlsx"), sheet = 1)
garcia_signature = garcia_table %>%
filter(genename!="None") %>%
filter(logFC < -2,FDR<0.00001) %>%
pull(genename) %>%
unique()
graham_signature = read.table(paste0(base_dir, "input_data/signatures/graham_quiescence_up.txt"), header = F)$V1
mep_sig = read.table(paste0(base_dir, "input_data/signatures/mep_sig.tsv"))$x
gmp_sig = read.table(paste0(base_dir, "input_data/signatures/gmp_sig.tsv"))$x
clp_sig = read.table(paste0(base_dir, "input_data/signatures/clp_sig.tsv"))$x
mhc_ii = c("HLA-DMA", "HLA-DMB", "HLA-DOA", "HLA-DOB", "HLA-DPA1", "HLA-DPB1", "HLA-DQA1", "HLA-DQB1", "HLA-DRA", "HLA-DRB1", "HLA-DRB5", "CD74")
hallmark_pathways = gmtPathways(paste0(base_dir, "input_data/signatures/h.all.v2024.1.Hs.symbols.gmt.txt"))
c2_cp_pathways = gmtPathways(paste0(base_dir, "input_data/signatures/c2.cp.v2024.1.Hs.symbols.gmt.txt"))
pathways = list(graham_signature, garcia_signature, aging_sig, mep_sig, gmp_sig, clp_sig, mhc_ii, c2_cp_pathways$KEGG_ANTIGEN_PROCESSING_AND_PRESENTATION, hallmark_pathways$HALLMARK_TNFA_SIGNALING_VIA_NFKB, hallmark_pathways$HALLMARK_INTERFERON_ALPHA_RESPONSE, hallmark_pathways$HALLMARK_INTERFERON_GAMMA_RESPONSE, c2_cp_pathways$REACTOME_CELL_CYCLE)
names(pathways) = c("Graham_quiescence", "Garcia_quiescence", "Aging_signature", "MEP_signature", "GMP_signature", "CLP_signature", "MHC-II", "KEGG_ANTIGEN_PROCESSING_AND_PRESENTATION", "HALLMARK_TNFA_SIGNALING_VIA_NFKB", "HALLMARK_INTERFERON_ALPHA_RESPONSE", "HALLMARK_INTERFERON_GAMMA_RESPONSE", "REACTOME_CELL_CYCLE")
seu_total = NormalizeData(seu_total)
seu_total = AddModuleScore(seu_total, pathways, search = T)
colnames(seu_total@meta.data)[(ncol(seu_total@meta.data)-length(pathways) + 1):ncol(seu_total@meta.data)] = names(pathways)
colnames(seu_total@meta.data) # Check
usage_files = list.files(paste0("starcat_usages"), pattern = paste0(".starcat_usage.csv$"), recursive = TRUE, full.names = T)
usage_df = data.frame()
for (i in 1:length(usage_files)) {
t = read.table(usage_files[i], sep=",", header = T, row.names = 1)
usage_df = rbind(usage_df, t)
}
programs = colnames(usage_df)
usage_df = usage_df %>%
rownames_to_column("Cell") %>%
rowwise() %>%
mutate(Predominant_program = colnames(select(., starts_with("metaGEP")))[which.max(c_across(starts_with("metaGEP")))])
# Read UMAP coordinates from scVI-corrected object
seu_scVI = MuDataSeurat::ReadH5AD(paste0(base_dir, "3_scVI_integration/integrated_seu.h5ad"))
seu_scVI@meta.data[c("umap_1", "umap_2")] = NULL
umap_coords = Embeddings(seu_scVI, reduction = "umap")
scvi_coords = Embeddings(seu_scVI, reduction = "scVI")
seu = seu_total
usage_df = usage_df[match(colnames(seu), usage_df$Cell),]
all(colnames(seu) == usage_df$Cell)
all(colnames(seu) == rownames(umap_coords))
usage_df = cbind(usage_df, seu_scVI$leiden_0.5)
seu = AddMetaData(seu, usage_df)
seu[["umap"]] = CreateDimReducObject(embeddings = umap_coords, key = "UMAP_", assay = DefaultAssay(seu))
seu[["scVI"]] = CreateDimReducObject(embeddings = scvi_coords, key = "SCVI_", assay = DefaultAssay(seu))
seu = FindNeighbors(seu, reduction = "scVI", dims = 1:30)
seu = RunUMAP(seu, reduction = "scVI", dims = 1:30, reduction.name = "umap_new")
# Save final Seurat object
saveRDS(seu, "annotated_seu.rds")
plot_umap = DimPlot(seu %>% subset(Cohort %in% c("Aged", "Young")),
group.by = "Predominant_program",
reduction = "umap",
shuffle = T,
pt.size = 0.2) &
scale_color_manual(values = hcl.colors(length(programs), "Roma")) &
coord_fixed() &
guides(color=guide_legend(ncol=2,
override.aes = list(size=2))) &
theme_pubr(base_size = 5) &
theme(axis.line = element_line(linewidth=0.4),
legend.text = element_text(size=5),
legend.key.height = unit(0.25, "cm"))
fraction_df = seu@meta.data %>%
dplyr::select(Sample, Dataset, Cohort, Predominant_program) %>%
group_by(Sample, Dataset, Cohort, Predominant_program) %>%
summarize(cell_count_per_program = n()) %>%
group_by(Sample, Dataset, Cohort) %>%
mutate(cell_count = sum(cell_count_per_program)) %>%
filter(cell_count>=20) %>%
mutate(program_fraction = cell_count_per_program/cell_count) %>%
filter(Cohort %in% c("Young", "Aged")) %>%
mutate(Cohort = factor(Cohort, levels = c("Young", "Aged")))
stat.test = fraction_df %>%
group_by(Predominant_program) %>%
wilcox_test(program_fraction ~ Cohort) %>%
adjust_pvalue(method = "bonferroni") %>%
add_xy_position(x = "Cohort")
Ad Ai Ho Li Sa We Zh
color_palette = brewer.pal(12, "Paired")[c(4,2,12,8,9,1,6)]
color_palette[4] = "#ffcb00"
plot_fractions = ggplot(data = fraction_df,
aes(y=program_fraction, x=Cohort)) +
geom_boxplot(aes(fill=Cohort), outlier.shape = NA, linewidth=0.25) +
scale_fill_manual(values = c("#c7d1ca", "#617a6a"),
guide = guide_legend(ncol = 1,
title.position = "top",
)) +
ggnewscale::new_scale_fill() +
geom_point(aes(fill=Dataset), position=position_jitterdodge(dodge.width = 0.1), colour="black", pch=21, size=1,stroke=0.25) +
facet_wrap(Predominant_program~., nrow=1) +
scale_fill_manual(values = color_palette,
guide = guide_legend(ncol = 2,
title.position = "top",
override.aes = list(size=2))) +
theme_pubr(base_size = 5) +
stat_pvalue_manual(size=5/2.83465, stat.test, label = "p = {scales::pvalue(p.adj)}", bracket.size = 0.25) +
scale_y_continuous(limits = c(0,1.15),
name = "Fraction of predominant program",
breaks = c(0,0.25,0.5,0.75,1)) +
theme(axis.line = element_line(linewidth=0.4),
strip.background = element_rect(colour="black", fill="white",
linewidth=0.4, linetype="solid"),
strip.text = element_text(size=5),
legend.key.height = unit(0.25, "cm"),
legend.spacing.y = unit(0, "mm"),
legend.box.spacing = unit(0, "mm"),
legend.box = "horizontal",
legend.margin = margin(0,0,0,0),
legend.text = element_text(size=5))
p_final = ggarrange(plot_umap, plot_fractions, nrow = 1, widths = c(0.4,0.7))
save_plot("Fig.2d.e.pdf", p_final, base_height = 50, base_width = 100, units="mm")
plot_fractions
