# Heterogeneity in aging HSCs

### Overview
This repository replicates the analysis in [preprint](https://doi.org/10.1101/2025.09.01.673389). Directories `1_ .. 7_ revision` describe different parts of the analysis and should be run in order, as well as numbered scripts inside each directory. All shell scripts (`*.sh`) were run remotely on a computational cluster.

The final objects prepared in `1_dataset_preparation/` and `5_cNMF_analysis/` are available through **Figshare**.

### Directory description
- `1_dataset_preparation/` - Read input data for each dataset, map each dataset onto the BoneMarrowMap atlas, annotate HSCs, and create a Seurat object and `.h5ad` objects for `scVI` and `cNMF`. This creates **Fig. 1a**.
- `2_differential_expression_analysis/` - Run `DESeq2` and `GSEA`. This creates **Fig. 1b,c** and **Suppl. Fig. 2**.
- `3_scVI_integration/` - Integrate HSCs for visualization. Integrate HSPCs to validate BoneMarrowMap-produced HSC annotations. This creates **Suppl. Fig. 1** with annotation comparisons.
- `4_cNMF_run/` - Run `cNMF` and collect results (on a computational cluster).
- `5_cNMF_analysis/` - Load `cNMF` results, define metaGEPs, score metaGEP usages by `starCAT`, compare signature recovery to a random gene set. This creates **Fig. 1d,e,f**, **Fig. 2d,e**, **Suppl. Fig. 3,5,6,8**.
- `6_SCENIC/` - Run `SCENIC` on individual datasets and analyze results. This creates **Fig. 1h**, **Fig. 2h**, **Suppl. Fig. 4,7**.
- `7_CNA/` - Run `CNA`. This creates **Fig. 1g**.
- `revision/` - Analysis conducted during manuscript revision. This creates panels for **Fig. 2h-j**, **Suppl. Fig. 9-10**, and figures in **Supplementary Note**.

### Shared Seurat objects
On [Figshare](https://figshare.com/projects/Aging_HSCs_2025/235781), the following three `.rds` objects are shared:
- `seu_full_object_hscs_marked.rds`. The object contains 204,535 cells across seven datasets and 98 samples, where each pre-processed dataset was mapped onto the BoneMarrowMap atlas, and HSCs are marked by `seu$is_hsc`. Generated by `1_dataset_preparation/8_BoneMarrowMap_annotation.R`.

- `seu_hsc.total.rds`. A subset of `seu_full_object_hscs_marked.rds`, contains 28,989 HSCs. Generated by `1_dataset_preparation/8_BoneMarrowMap_annotation.R`.

- `annotated_seu.rds`. The final annotated HSC object with metaGEP usages, gene set signature scores, and scVI-based UMAP coordinates. Generated by `5_cNMF_analysis/8_assign_cell_states.R`.
